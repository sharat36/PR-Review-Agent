<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI PR Reviewer</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    h1 {
      margin-bottom: 15px;
      font-size: 24px;
      color: #222;
    }

    form {
      background: #fff;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    input[type="text"] {
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      flex: 1;
      min-width: 180px;
    }

    button {
      padding: 8px 16px;
      background-color: #00c292;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: #00a87d;
    }

    #streamContainer {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .func-card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .func-header {
      background: #f8f9fa;
      font-weight: bold;
      padding: 10px 15px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .func-body {
      padding: 12px 15px;
      font-family: monospace;
      white-space: pre-wrap;
      display: block;
    }

    .func-body.collapsed {
      display: none;
    }

    .reply-box {
      display: flex;
      gap: 10px;
      padding: 10px 15px;
      background: #f0f3f8;
      border-top: 1px solid #ccc;
    }

    .reply-box input {
      flex: 1;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #aaa;
    }

    .reply-box button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
    }

    .toggle-button {
      background: none;
      border: none;
      font-size: 16px;
      color: #00a87d;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üîç AI PR Reviewer</h1>

  <form id="startForm">
    <input type="text" name="repo" placeholder="/full/path/to/repo" required>
    <input type="text" name="base" placeholder="base branch (e.g. main)" required>
    <input type="text" name="pr" placeholder="PR branch (e.g. feature/fix)" required>
    <button type="submit">Start Review</button>
  </form>

  <div id="streamContainer"></div>

  <script>
    const streamContainer = document.getElementById("streamContainer");
    const functionCards = {};

    const evtSource = new EventSource("/stream");

    evtSource.onmessage = function(event) {
      const message = event.data;

      // Start new card
      if (message.includes("üîç Reviewing:")) {
        const match = message.match(/üîç Reviewing: (.*?) in (.*)/);
        if (!match) return;
        const funcName = match[1].trim();
        const filePath = match[2].trim();
        const funcKey = `${filePath}::${funcName}`;

        const card = document.createElement("div");
        card.classList.add("func-card");

        const header = document.createElement("div");
        header.classList.add("func-header");

        const title = document.createElement("div");
        title.textContent = message;

        const toggle = document.createElement("button");
        toggle.innerHTML = "‚ûñ";
        toggle.className = "toggle-button";

        const body = document.createElement("div");
        body.classList.add("func-body");

        toggle.onclick = () => {
          body.classList.toggle("collapsed");
          toggle.innerHTML = body.classList.contains("collapsed") ? "‚ûï" : "‚ûñ";
        };

        header.appendChild(title);
        header.appendChild(toggle);
        card.appendChild(header);
        card.appendChild(body);
        streamContainer.appendChild(card);

        functionCards[funcKey] = { card, body };
        console.log("‚úÖ Card created for:", funcKey);
        return;
      }

      // STREAM::<file>::<function>::<message>
      if (message.startsWith("STREAM::") || message.startsWith("USER_INPUT_REQUEST::")) {
        const parts = message.split("::");
        const type = parts[0];
        const funcKey = parts[1] + "::" + parts[2];
        const content = parts.slice(3).join("::").replace(/\\n/g, "<br/>");

        console.log(`üì• ${type} for ${funcKey}`);

        const card = functionCards[funcKey];
        if (!card) {
          console.warn("‚ùå No matching card for:", funcKey);
          return;
        }

        if (type === "STREAM") {
          const div = document.createElement("div");
          div.innerHTML = content;
          card.body.appendChild(div);
        } else if (type === "USER_INPUT_REQUEST") {
          const replyBox = document.createElement("div");
          replyBox.classList.add("reply-box");
          replyBox.innerHTML = `
            <input type="text" class="replyInput" placeholder="${content}" />
            <button class="replySendBtn">Send</button>
          `;

          const replyInput = replyBox.querySelector("input");
          const replyBtn = replyBox.querySelector("button");

          replyBtn.onclick = function () {
            const reply = replyInput.value;
            if (!reply) return;

            fetch("/chat_reply", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: "reply=" + encodeURIComponent(reply)
            }).then(() => {
              const response = document.createElement("div");
              response.innerHTML = `<b>üôã You:</b> ${reply}`;
              card.body.appendChild(response);
              replyBox.remove();
            });
          };

          card.card.appendChild(replyBox);
          replyInput.focus();
        }
      }
    };

    // Clear on Start Review
    document.getElementById("startForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      streamContainer.innerHTML = "";
      fetch("/start", { method: "POST", body: formData });
    });
  </script>
</body>
</html>
